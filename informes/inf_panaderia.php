<?phpsession_start();include("../conexion/conectarbd.php");$conexion=Conectarse();include("../funciones/generales.php");if (!isset($_SESSION['cod_usuario']))  die("No esta autorizado a ingresar al sitio (Clave o nombre de Usuario incorrecto)");////SACAMOS EL NOMBRE DEL INFORME$url = $_SERVER['REQUEST_URI'];$array = explode('/',$url);//print("$array[3]"); ////EL NIVEL 3 ES EL NOMBRE DEL INFORME PARA VALIDAR QUE EL USUARIO TENGA ACCESO A ESE INFORME$num_array = count($array);$num_array = $num_array - 1; $informe = $array[$num_array];$separar = explode('?',$informe);$informe = $separar[0];$login = $_SESSION['login'];$cod_usuario = $_SESSION['cod_usuario'];$nom_usuario = $_SESSION['nombre'];$ape_usuario = $_SESSION['apellidos'];$num_reg_pag = $_SESSION['num_reg_pag']; ////LLAMAMOS LA FUNCION QUE DEFINE EL PERFIL DE VISTA DE LA OPCION $opcion_vista = opcion_vista($informe,$cod_usuario,$conexion);   $registro = "SELECT opcion.ruta FROM usuario_opcion             INNER JOIN usuario ON usuario.cod_usuario=usuario_opcion.cod_usuario             INNER JOIN opcion ON opcion.id_opcion=usuario_opcion.id_opcion             WHERE usuario.cod_usuario=$cod_usuario AND opcion.ruta like '%$informe%'";$result = mysql_query($registro);error_consulta($result,$registro);                                   if($reg=mysql_fetch_array($result)){       $autorizado=1;      }  if(($cod_usuario != '') && ($autorizado==1)){    }else{      die("<br>No ha iniciado una sesión O no puede acceder a esta pagina por su perfil.");      } ?><HTML LANG="es">  <HEAD><TITLE>INFORME DE PRODUCTOS DE PANADERIA</TITLE><link rel="stylesheet" type="text/css" href="../estilos/estilo.css"><SCRIPT SRC="../calendar/calendar.js"></SCRIPT><SCRIPT LANGUAGE='JavaScript'><!--   ////FUNCION QUE ACTUALIZA LA PAGINA AL CAMBIAR LOS PARAMETROS DE LA CONSULTA   function actualizaPagina (){      i = document.forms.datechooser.programacion.selectedIndex;      programacion = document.forms.datechooser.programacion.options[i].value;      m = document.forms.datechooser.programacion2.selectedIndex;      programacion2 = document.forms.datechooser.programacion2.options[m].value;        n = document.forms.datechooser.programacion3.selectedIndex;      programacion3 = document.forms.datechooser.programacion3.options[n].value;        o = document.forms.datechooser.programacion4.selectedIndex;      programacion4 = document.forms.datechooser.programacion4.options[o].value;                  p = document.forms.datechooser.programacion5.selectedIndex;      programacion5 = document.forms.datechooser.programacion5.options[p].value;                q = document.forms.datechooser.programacion6.selectedIndex;      programacion6 = document.forms.datechooser.programacion6.options[q].value;             r = document.forms.datechooser.programacion7.selectedIndex;      programacion7 = document.forms.datechooser.programacion7.options[r].value;                                 j = document.forms.datechooser.menu.selectedIndex;      menu = document.forms.datechooser.menu.options[j].value;       h = document.forms.datechooser.departamento.selectedIndex;      departamento = document.forms.datechooser.departamento.options[h].value;             tipo_minuta = document.forms.datechooser.tipo_minuta.value;               k = document.forms.datechooser.pagina.selectedIndex;      pagina = document.forms.datechooser.pagina.options[k].value;                  window.location = 'inf_panaderia.php?programacion='+programacion+'&departamento='+departamento+'&programacion2='+programacion2+'&programacion3='+programacion3+'&pagina='+pagina+'&menu='+menu+'&tipo_minuta='+tipo_minuta+'&programacion4='+programacion4+'&programacion5='+programacion5+'&programacion6='+programacion6+'&programacion7='+programacion7;   }// --></SCRIPT></head><body><table width='95%'><tr><td width='30%' style='font-weight:bold; color: white' align="left">Bienvenido&nbsp;&nbsp;&nbsp;<img src="../imagenes/usuario.png">&nbsp;&nbsp;&nbsp;<?php print("$nom_usuario $ape_usuario");?></td><td width='30%' style='font-weight:bold; color: white' align="right"><a href="../menu_retorna.php" align="right"><img src="../imagenes/retornar.png">&nbsp;Retornar</a> | <a href="../logout.php"><img src="../imagenes/exit.png">&nbsp;Cerrar sesión</a></td></tr></table><br><div align="Center"><?PHPsession_start();  $autorizado=0;  $registro = "SELECT opcion.ruta FROM usuario_opcion               INNER JOIN usuario ON usuario.cod_usuario=usuario_opcion.cod_usuario               INNER JOIN opcion ON opcion.id_opcion=usuario_opcion.id_opcion               WHERE usuario.cod_usuario=$cod_usuario AND opcion.ruta like '%$informe%'";  $result = mysql_query($registro);  error_consulta($result,$registro);                                       if($reg=mysql_fetch_array($result)){         $autorizado=1;        }    if(($cod_usuario != '') && ($autorizado==1)){      }else{        die("<br>No ha iniciado una sesión 1 O no puede acceder a esta pagina por su perfil.");        }       ////RECIBIMOS LOS PARAMETROS Q VIENEN EN LA URL      $cod_programacion  = $_REQUEST['programacion'];      $cod_programacion2 = $_REQUEST['programacion2'];      $cod_programacion3 = $_REQUEST['programacion3'];      $cod_programacion4 = $_REQUEST['programacion4'];      $cod_programacion5 = $_REQUEST['programacion5'];      $cod_programacion6 = $_REQUEST['programacion6'];      $cod_programacion7 = $_REQUEST['programacion7'];      $cod_menu = $_REQUEST['menu'];      $cod_departamento = $_REQUEST['departamento'];      $tipo_minuta = $_REQUEST['tipo_minuta'];      $pagina = $_REQUEST['pagina'];             if($pagina>0){          $pagina = $pagina - $num_reg_pag;         }else{           $pagina = 0;           }      ////DETERMINAMOS EL NUMERO DE PAGINAS QUE SE DEBEN MOSTRAR      $instruccion3 = "SELECT count(cod_escuela) AS cuenta FROM escuela";      $consulta3 = mysql_query ($instruccion3, $conexion);        $row3 = mysql_fetch_array ($consulta3);      $cuenta = $row3['cuenta'];            $cuenta = 0; ////NO SE MUESTRA PAGINACION EN ESTE FORMULARIO              if($cuenta>$num_reg_pag){         $num_paginas = $cuenta / $num_reg_pag;        }else{           $num_paginas = 0;          }                 ////MOSTRAMOS EL FORMULARIO DONDE SE UBICAN LOS FILTROS      print ("<TABLE width='80%' align='center'>");      print ("<FORM NAME='datechooser' ACTION='inf_panaderia.php' METHOD='POST'>");      print ("<TR style='font-weight:bold; color: white'>");            ////BUSCAMOS LAS PROGRAMACIONES      print ("<TD>Programación 1 ");      print ("&nbsp;&nbsp;<img src='../imagenes/requerido.gif'><SELECT NAME='programacion'>");                      $instruccion = "SELECT DISTINCT programacion.cod_programacion AS cod_programacion, ciclo.nombre AS nombre                      FROM programacion                       INNER JOIN ciclo ON ciclo.cod_ciclo = programacion.cod_ciclo                       WHERE programacion.estado = 1                      ORDER BY programacion.cod_programacion DESC";      $consulta = mysql_query ($instruccion, $conexion);      $row = mysql_fetch_array ($consulta);               $valdesc = "";      $descp = "--";          print("<option value=".$valdesc.">".$descp."</option>");          do{            print("<option value=".$row['cod_programacion'].">[".$row['cod_programacion']."] - [".$row['nombre']."]</option>");        }while ($row = mysql_fetch_array($consulta));         print("</SELECT></TD>");          ////BUSCAMOS LAS PROGRAMACIONES      print ("<TD>Programación 2 ");      print ("&nbsp;&nbsp;<img src='../imagenes/requerido.gif'><SELECT NAME='programacion2'>");                      $instruccion = "SELECT DISTINCT programacion.cod_programacion AS cod_programacion, ciclo.nombre AS nombre                      FROM programacion                       INNER JOIN ciclo ON ciclo.cod_ciclo = programacion.cod_ciclo                       WHERE programacion.estado = 1                      ORDER BY programacion.cod_programacion DESC";      $consulta = mysql_query ($instruccion, $conexion);      $row = mysql_fetch_array ($consulta);               $valdesc = "";      $descp = "--";          print("<option value=".$valdesc.">".$descp."</option>");          do{            print("<option value=".$row['cod_programacion'].">[".$row['cod_programacion']."] - [".$row['nombre']."]</option>");        }while ($row = mysql_fetch_array($consulta));         print("</SELECT></TD></TR>");                           ////BUSCAMOS LAS PROGRAMACIONES      print ("<TR  style='font-weight:bold; color: white'><TD>Programación 3");      print ("&nbsp;&nbsp;<img src='../imagenes/requerido.gif'><SELECT NAME='programacion3'>");                      $instruccion = "SELECT DISTINCT programacion.cod_programacion AS cod_programacion, ciclo.nombre AS nombre                      FROM programacion                       INNER JOIN ciclo ON ciclo.cod_ciclo = programacion.cod_ciclo                       WHERE programacion.estado = 1                      ORDER BY programacion.cod_programacion DESC";      $consulta = mysql_query ($instruccion, $conexion);      $row = mysql_fetch_array ($consulta);               $valdesc = "";      $descp = "--";          print("<option value=".$valdesc.">".$descp."</option>");          do{            print("<option value=".$row['cod_programacion'].">[".$row['cod_programacion']."] - [".$row['nombre']."]</option>");        }while ($row = mysql_fetch_array($consulta));         print("</SELECT></TD>");               ////BUSCAMOS LAS PROGRAMACIONES      print ("<TD>Programación 4");      print ("&nbsp;&nbsp;<img src='../imagenes/requerido.gif'><SELECT NAME='programacion4'>");                      $instruccion = "SELECT DISTINCT programacion.cod_programacion AS cod_programacion, ciclo.nombre AS nombre                      FROM programacion                       INNER JOIN ciclo ON ciclo.cod_ciclo = programacion.cod_ciclo                       WHERE programacion.estado = 1                      ORDER BY programacion.cod_programacion DESC";      $consulta = mysql_query ($instruccion, $conexion);      $row = mysql_fetch_array ($consulta);               $valdesc = "";      $descp = "--";          print("<option value=".$valdesc.">".$descp."</option>");          do{            print("<option value=".$row['cod_programacion'].">[".$row['cod_programacion']."] - [".$row['nombre']."]</option>");        }while ($row = mysql_fetch_array($consulta));         print("</SELECT></TD></TR>");                ////BUSCAMOS LAS PROGRAMACIONES      print ("<TR style='font-weight:bold; color: white'><TD>Programación 5");      print ("&nbsp;&nbsp;<img src='../imagenes/requerido.gif'><SELECT NAME='programacion5'>");                      $instruccion = "SELECT DISTINCT programacion.cod_programacion AS cod_programacion, ciclo.nombre AS nombre                      FROM programacion                       INNER JOIN ciclo ON ciclo.cod_ciclo = programacion.cod_ciclo                       WHERE programacion.estado = 1                      ORDER BY programacion.cod_programacion DESC";      $consulta = mysql_query ($instruccion, $conexion);      $row = mysql_fetch_array ($consulta);               $valdesc = "";      $descp = "--";          print("<option value=".$valdesc.">".$descp."</option>");          do{            print("<option value=".$row['cod_programacion'].">[".$row['cod_programacion']."] - [".$row['nombre']."]</option>");        }while ($row = mysql_fetch_array($consulta));         print("</SELECT></TD>");               ////BUSCAMOS LAS PROGRAMACIONES      print ("<TD>Programación 6");      print ("&nbsp;&nbsp;<img src='../imagenes/requerido.gif'><SELECT NAME='programacion6'>");                      $instruccion = "SELECT DISTINCT programacion.cod_programacion AS cod_programacion, ciclo.nombre AS nombre                      FROM programacion                       INNER JOIN ciclo ON ciclo.cod_ciclo = programacion.cod_ciclo                       WHERE programacion.estado = 1                      ORDER BY programacion.cod_programacion DESC";      $consulta = mysql_query ($instruccion, $conexion);      $row = mysql_fetch_array ($consulta);               $valdesc = "";      $descp = "--";          print("<option value=".$valdesc.">".$descp."</option>");          do{            print("<option value=".$row['cod_programacion'].">[".$row['cod_programacion']."] - [".$row['nombre']."]</option>");        }while ($row = mysql_fetch_array($consulta));         print("</SELECT></TD></TR>");                      ////BUSCAMOS LAS PROGRAMACIONES      print ("<TR style='font-weight:bold; color: white'><TD>Programación 7");      print ("&nbsp;&nbsp;<img src='../imagenes/requerido.gif'><SELECT NAME='programacion7'>");                      $instruccion = "SELECT DISTINCT programacion.cod_programacion AS cod_programacion, ciclo.nombre AS nombre                      FROM programacion                       INNER JOIN ciclo ON ciclo.cod_ciclo = programacion.cod_ciclo                       WHERE programacion.estado = 1                      ORDER BY programacion.cod_programacion DESC";      $consulta = mysql_query ($instruccion, $conexion);      $row = mysql_fetch_array ($consulta);               $valdesc = "";      $descp = "--";          print("<option value=".$valdesc.">".$descp."</option>");          do{            print("<option value=".$row['cod_programacion'].">[".$row['cod_programacion']."] - [".$row['nombre']."]</option>");        }while ($row = mysql_fetch_array($consulta));         print("</SELECT></TD></TR>");       ////BUSCAMOS LOS MENUS      print ("<TR style='font-weight:bold; color: white'><TD>Menu ");      print ("<SELECT NAME='menu'>");                      $instruccion = "SELECT cod_menu, nombre FROM menu ORDER BY cod_menu";      $consulta = mysql_query ($instruccion, $conexion);      $row = mysql_fetch_array ($consulta);               $valdesc = "";      $descp = "--";          print("<option value=".$valdesc.">".$descp."</option>");          do{            print("<option value=".$row['cod_menu'].">".$row['nombre']."</option>");        }while ($row = mysql_fetch_array($consulta));         print("</SELECT></TD>");       ////BUSCAMOS LOS DEPARTAMENTOS      print ("<TD>Departamento ");      print ("<SELECT NAME='departamento'>");                      $instruccion = "SELECT cod_departamento, nombre FROM departamento ORDER BY cod_departamento";      $consulta = mysql_query ($instruccion, $conexion);      $row = mysql_fetch_array ($consulta);               $valdesc = "";      $descp = "--";          print("<option value=".$valdesc.">".$descp."</option>");          do{            print("<option value=".$row['cod_departamento'].">".$row['nombre']."</option>");        }while ($row = mysql_fetch_array($consulta));         print("</SELECT></TD>");                  print("<td>Separar por tipo de Minuta: <INPUT type='checkbox' name='tipo_minuta'>");                                             ////MOSTRAMOS LAS PAGINAS      if($num_paginas>0){        print ("<TD>Pagina ");        print ("<SELECT NAME='pagina'>");                 $cont_pag = 1;                 $valdesc_p = 0;        $descp_p = "--";            print("<option value=".$valdesc_p.">".$descp_p."</option>");            do{              print("<option value=".$cont_pag.">".$cont_pag."</option>");             $cont_pag++;          }while ($cont_pag<=$num_paginas);           print("</SELECT></TD>");           }                      print ("<TD><INPUT TYPE='submit' NAME='consultar' VALUE='Consultar'></TD>");        print ("</FORM>");      print ("</TD></TR><tr><td>&nbsp;</td></tr></table>");           ////GENERAMOS LA CONDICION DE LA CONSULTA      $condicion = " WHERE ";      if($cod_programacion != '' && $cod_programacion2 != '' && $cod_programacion3 != '' && $cod_programacion4 != '' && $cod_programacion5 != '' && $cod_programacion6 != '' && $cod_programacion7 != ''){         $condicion2 = $condicion2. "plato.panaderia = 1 AND  (calculo_requerimientos.cod_programacion = '$cod_programacion' OR  calculo_requerimientos.cod_programacion = '$cod_programacion2' OR  calculo_requerimientos.cod_programacion = '$cod_programacion3' OR  calculo_requerimientos.cod_programacion = '$cod_programacion4' OR  calculo_requerimientos.cod_programacion = '$cod_programacion5' OR  calculo_requerimientos.cod_programacion = '$cod_programacion6' OR  calculo_requerimientos.cod_programacion = '$cod_programacion7') AND ";        }             if($cod_menu!= ''){         $condicion2 = $condicion2. "calculo_requerimientos.cod_menu = '$cod_menu' AND ";        }      if($cod_departamento!= ''){         $condicion2 = $condicion2. "calculo_requerimientos.cod_departamento = '$cod_departamento' AND ";        }                                 $condicion2 = substr($condicion2, 0, -4);                 $condicion_final = $condicion.$condicion2;                    if($condicion_final == " WHERE "){           $condicion_final = " WHERE calculo_requerimientos.cod_programacion = 0";           $limit = "LIMIT ".$pagina.",".$num_reg_pag;           }else{            $limit = "";            }                if($tipo_minuta == 'on'){        ////EJECUTAMOS LA CONSULTA      $instruccion2 ="SELECT calculo_requerimientos.cod_plato AS cod_plato, plato.nombre AS nom_plato, SUM(calculo_requerimientos.cantidad) AS cantidad,                               calculo_requerimientos.cod_tipo_minuta AS cod_tipo_minuta, tipo_minuta.nombre AS nom_tipo_minuta,                              ingrediente.nombre AS nom_ingrediente, calculo_requerimientos.cod_ingrediente                       FROM calculo_requerimientos                       INNER JOIN plato ON calculo_requerimientos.cod_plato = plato.cod_plato                       INNER JOIN tipo_minuta ON tipo_minuta.cod_tipo_minuta = calculo_requerimientos.cod_tipo_minuta                      INNER JOIN ingrediente ON ingrediente.cod_ingrediente = calculo_requerimientos.cod_ingrediente                      $condicion_final                        GROUP BY calculo_requerimientos.cod_plato, calculo_requerimientos.cod_ingrediente, calculo_requerimientos.cod_tipo_minuta                       ORDER BY calculo_requerimientos.cod_tipo_minuta, calculo_requerimientos.cod_plato                                            ";        }else{      ////EJECUTAMOS LA CONSULTA      $instruccion2 ="SELECT calculo_requerimientos.cod_plato AS cod_plato, plato.nombre AS nom_plato, SUM(calculo_requerimientos.cantidad) AS cantidad,                             ingrediente.nombre AS nom_ingrediente, calculo_requerimientos.cod_ingrediente                      FROM calculo_requerimientos                       INNER JOIN plato ON calculo_requerimientos.cod_plato = plato.cod_plato                      INNER JOIN ingrediente ON ingrediente.cod_ingrediente = calculo_requerimientos.cod_ingrediente                      $condicion_final                        GROUP BY calculo_requerimientos.cod_plato, calculo_requerimientos.cod_ingrediente                       ORDER BY calculo_requerimientos.cod_plato                                           ";                }                      $consulta2 = mysql_query($instruccion2);      error_consulta($consulta2,$instruccion2);      ////MOSTRAMOS LOS RESULTADOS DE LA CONSULTA      $nfilas = mysql_num_rows ($consulta2);       if ($nfilas > 0){       if($cod_programacion != '' && $cod_programacion2 != '' && $cod_programacion3 != '' && $cod_programacion4 != '' && $cod_programacion5 != '' && $cod_programacion6 != '' && $cod_programacion7 != ''){                 if($cod_menu != ''){           ////BUSCAMOS EL NOMBRE DEL MENU          $instruccion_menu ="SELECT nombre AS nom_menu FROM menu WHERE cod_menu = $cod_menu";                   $consulta_menu = mysql_query($instruccion_menu);          error_consulta($consulta_menu,$instruccion_menu);          $row_menu = mysql_fetch_array($consulta_menu);                      $nom_menu = $row_menu['nom_menu'];                     $cad_menu = "[Menu: $nom_menu]";          }              ////ENCABEZADO DE LA TABLA DE RESULTADOS        $hojaExcel="<TABLE width='60%'>";        $hojaExcel.="<TR><TH colspan='5'><center>INFORME DE PANADERIA -- [Programación: $cod_programacion Y $cod_programacion2 Y $cod_programacion3 Y $cod_programacion4 Y $cod_programacion5 Y $cod_programacion6 Y $cod_programacion7] $cad_menu </center></TH></TR>";               $hojaExcel.="<TH colspan='2'><center>Plato</center></TH>";        $hojaExcel.="<TH colspan='2'><center>Producto</center></TH>";        $hojaExcel.="<TH><center>Cantidad</center></TH>";        $hojaExcel.="</TR>";              $color = '';         for ($i=0; $i<$nfilas; $i++){            ////DEFINIMOS EL COLOR DE LA FILA            $resto = $i%2;                        if($resto==0){               $color = '#D8D8D8';              }            if($resto!=0){               $color = '#848484';              }                          ////ESCRIBIMOS LOS RESULTADOS            $row2 = mysql_fetch_array($consulta2);            if($tipo_minuta == 'on'){               $cod_tipo_minuta = $row2['cod_tipo_minuta'];                            if($cod_tipo_minuta != $ant_cod_tipo_minuta){                $hojaExcel.="<TR>";                $hojaExcel.="<TH colspan='3'><center>" . $row2['nom_tipo_minuta'] ." </center></TH>";                 $hojaExcel.="</TR>";                                $ant_cod_tipo_minuta =  $cod_tipo_minuta;               }                                        }                        $hojaExcel.="<TR>";            $hojaExcel.="<TD style=background:$color>" . $row2['cod_plato'] ."</TD>";             $hojaExcel.="<TD style=background:$color>" . $row2['nom_plato'] ."</TD>";            $hojaExcel.="<TD style=background:$color>" . $row2['cod_ingrediente'] ."</TD>";            $hojaExcel.="<TD style=background:$color>" . $row2['nom_ingrediente'] ."</TD>";             $hojaExcel.="<TD style=background:$color>" . $row2['cantidad'] . "</TD>";            $hojaExcel.="</TR>";         }         $hojaExcel.="</TABLE>";             echo $hojaExcel;                    $login=trim($_SESSION['login']);          $fecha = date("Ymd_His");          $sfile="../excel/InformePanaderia"._."$login"._."$fecha.xls"; //ruta del archivo a generar           $fp=fopen($sfile,"w");           fwrite($fp,$hojaExcel);           fclose($fp);          echo "<br><a href='../excel/".$sfile."'><img src='../imagenes/excel.png' width='36' height='36' alt='Exportar a Microsoft Excel'></a>";           }else{            print ("<center><span class='Estilo1'>Debe seleccionar las Programaciones para generar el Informe</span></center>");            }       }else         print ("<center><span class='Estilo1'>No hay informacion disponible</span></center>");////Cerrar conexiónmysql_close ($conexion);?></div></body></html>