<?phpini_set('max_execution_time',0);session_start();include("../conexion/conectarbd.php");$conexion=Conectarse();include("../funciones/generales.php");if (!isset($_SESSION['cod_usuario']))  die("No esta autorizado a ingresar al sitio (Clave o nombre de Usuario incorrecto)");////SACAMOS EL NOMBRE DEL INFORME$url = $_SERVER['REQUEST_URI'];$array = explode('/',$url);//print("$array[3]"); ////EL NIVEL 3 ES EL NOMBRE DEL INFORME PARA VALIDAR QUE EL USUARIO TENGA ACCESO A ESE INFORME$num_array = count($array);$num_array = $num_array - 1; $informe = $array[$num_array];$separar = explode('?',$informe);$informe = $separar[0];$login = $_SESSION['login'];$cod_usuario = $_SESSION['cod_usuario'];$nom_usuario = $_SESSION['nombre'];$ape_usuario = $_SESSION['apellidos'];$num_reg_pag = $_SESSION['num_reg_pag']; ////LLAMAMOS LA FUNCION QUE DEFINE EL PERFIL DE VISTA DE LA OPCION $opcion_vista = opcion_vista($informe,$cod_usuario,$conexion);   $registro = "SELECT opcion.ruta FROM usuario_opcion             INNER JOIN usuario ON usuario.cod_usuario=usuario_opcion.cod_usuario             INNER JOIN opcion ON opcion.id_opcion=usuario_opcion.id_opcion             WHERE usuario.cod_usuario=$cod_usuario AND opcion.ruta like '%$informe%'";$result = mysql_query($registro);error_consulta($result,$registro);                                   if($reg=mysql_fetch_array($result)){       $autorizado=1;      }  if(($cod_usuario != '') && ($autorizado==1)){    }else{      die("<br>No ha iniciado una sesión O no puede acceder a esta pagina por su perfil.");      } ?><HTML LANG="es">  <HEAD><TITLE>INFORME DE BIENESTARINA</TITLE><link rel="stylesheet" type="text/css" href="../estilos/estilo.css"><SCRIPT SRC="../calendar/calendar.js"></SCRIPT><SCRIPT LANGUAGE='JavaScript'><!--   ////FUNCION QUE ACTUALIZA LA PAGINA AL CAMBIAR LOS PARAMETROS DE LA CONSULTA   function actualizaPagina (){      i = document.forms.datechooser.programacion.selectedIndex;      programacion = document.forms.datechooser.programacion.options[i].value;      m = document.forms.datechooser.programacion2.selectedIndex;      programacion2 = document.forms.datechooser.programacion2.options[m].value;        n = document.forms.datechooser.programacion3.selectedIndex;      programacion3 = document.forms.datechooser.programacion3.options[n].value;                o = document.forms.datechooser.programacion4.selectedIndex;      programacion4 = document.forms.datechooser.programacion4.options[o].value;           h = document.forms.datechooser.departamento.selectedIndex;      departamento = document.forms.datechooser.departamento.options[h].value;             k = document.forms.datechooser.pagina.selectedIndex;      pagina = document.forms.datechooser.pagina.options[k].value;                  window.location = 'inf_bienestarina.php?programacion='+programacion+'&departamento='+departamento+'&programacion2='+programacion2+'&programacion3='+programacion3+'&programacion4='+programacion4+'&pagina='+pagina;   }// --></SCRIPT></head><body><table width='95%'><tr><td width='30%' style='font-weight:bold; color: white' align="left">Bienvenido&nbsp;&nbsp;&nbsp;<img src="../imagenes/usuario.png">&nbsp;&nbsp;&nbsp;<?php print("$nom_usuario $ape_usuario");?></td><td width='30%' style='font-weight:bold; color: white' align="right"><a href="../menu_retorna.php" align="right"><img src="../imagenes/retornar.png">&nbsp;Retornar</a> | <a href="../logout.php"><img src="../imagenes/exit.png">&nbsp;Cerrar sesión</a></td></tr></table><br><div align="Center"><?PHPsession_start();  $autorizado=0;  $registro = "SELECT opcion.ruta FROM usuario_opcion               INNER JOIN usuario ON usuario.cod_usuario=usuario_opcion.cod_usuario               INNER JOIN opcion ON opcion.id_opcion=usuario_opcion.id_opcion               WHERE usuario.cod_usuario=$cod_usuario AND opcion.ruta like '%$informe%'";  $result = mysql_query($registro);  error_consulta($result,$registro);                                       if($reg=mysql_fetch_array($result)){         $autorizado=1;        }    if(($cod_usuario != '') && ($autorizado==1)){      }else{        die("<br>No ha iniciado una sesión 1 O no puede acceder a esta pagina por su perfil.");        }       ////RECIBIMOS LOS PARAMETROS Q VIENEN EN LA URL      $cod_programacion  = $_REQUEST['programacion'];      $cod_programacion2 = $_REQUEST['programacion2'];      $cod_programacion3 = $_REQUEST['programacion3'];      $cod_programacion4 = $_REQUEST['programacion4'];      $cod_departamento = $_REQUEST['departamento'];      $pagina = $_REQUEST['pagina'];             if($pagina>0){          $pagina = $pagina - $num_reg_pag;         }else{           $pagina = 0;           }      ////DETERMINAMOS EL NUMERO DE PAGINAS QUE SE DEBEN MOSTRAR      $instruccion3 = "SELECT count(cod_escuela) AS cuenta FROM escuela";      $consulta3 = mysql_query ($instruccion3, $conexion);        $row3 = mysql_fetch_array ($consulta3);      $cuenta = $row3['cuenta'];            $cuenta = 0; ////NO SE MUESTRA PAGINACION EN ESTE FORMULARIO              if($cuenta>$num_reg_pag){         $num_paginas = $cuenta / $num_reg_pag;        }else{           $num_paginas = 0;          }                 ////MOSTRAMOS EL FORMULARIO DONDE SE UBICAN LOS FILTROS      print ("<TABLE width='80%' align='center'>");      print ("<FORM NAME='datechooser' ACTION='inf_bienestarina.php' METHOD='POST'>");      print ("<TR style='font-weight:bold; color: white'>");            ////BUSCAMOS LAS PROGRAMACIONES      print ("<TD>Programación ");      print ("&nbsp;&nbsp;<img src='../imagenes/requerido.gif'><SELECT NAME='programacion'>");                      $instruccion = "SELECT DISTINCT programacion.cod_programacion AS cod_programacion, ciclo.nombre AS nombre                      FROM programacion                       INNER JOIN ciclo ON ciclo.cod_ciclo = programacion.cod_ciclo                       WHERE programacion.estado = 1                      ORDER BY programacion.cod_programacion DESC";      $consulta = mysql_query ($instruccion, $conexion);      $row = mysql_fetch_array ($consulta);               $valdesc = "";      $descp = "--";          print("<option value=".$valdesc.">".$descp."</option>");          do{            print("<option value=".$row['cod_programacion'].">".$row['cod_programacion']." - [".$row['nombre']."]</option>");        }while ($row = mysql_fetch_array($consulta));         print("</SELECT></TD>");           ////BUSCAMOS LAS PROGRAMACIONES      print ("<TD>Programación 2 ");      print ("&nbsp;&nbsp;<img src='../imagenes/requerido.gif'><SELECT NAME='programacion2'>");                      $instruccion = "SELECT DISTINCT programacion.cod_programacion AS cod_programacion, ciclo.nombre AS nombre                      FROM programacion                       INNER JOIN ciclo ON ciclo.cod_ciclo = programacion.cod_ciclo                       WHERE programacion.estado = 1                      ORDER BY programacion.cod_programacion DESC";      $consulta = mysql_query ($instruccion, $conexion);      $row = mysql_fetch_array ($consulta);               $valdesc = "";      $descp = "--";          print("<option value=".$valdesc.">".$descp."</option>");          do{            print("<option value=".$row['cod_programacion'].">".$row['cod_programacion']." - [".$row['nombre']."]</option>");        }while ($row = mysql_fetch_array($consulta));         print("</SELECT></TD>");                       ////BUSCAMOS LAS PROGRAMACIONES      print ("<TD>Programación 3 ");      print ("&nbsp;&nbsp;<img src='../imagenes/requerido.gif'><SELECT NAME='programacion3'>");                      $instruccion = "SELECT DISTINCT programacion.cod_programacion AS cod_programacion, ciclo.nombre AS nombre                      FROM programacion                       INNER JOIN ciclo ON ciclo.cod_ciclo = programacion.cod_ciclo                       WHERE programacion.estado = 1                      ORDER BY programacion.cod_programacion DESC";      $consulta = mysql_query ($instruccion, $conexion);      $row = mysql_fetch_array ($consulta);                $valdesc = "";      $descp = "--";          print("<option value=".$valdesc.">".$descp."</option>");          do{            print("<option value=".$row['cod_programacion'].">".$row['cod_programacion']." - [".$row['nombre']."]</option>");        }while ($row = mysql_fetch_array($consulta));         print("</SELECT></TD></TR>");                ////BUSCAMOS LAS PROGRAMACIONES      print ("<TR style='font-weight:bold; color: white'><TD>Programación 4 ");      print ("&nbsp;&nbsp;<img src='../imagenes/requerido.gif'><SELECT NAME='programacion4'>");                      $instruccion = "SELECT DISTINCT programacion.cod_programacion AS cod_programacion, ciclo.nombre AS nombre                      FROM programacion                       INNER JOIN ciclo ON ciclo.cod_ciclo = programacion.cod_ciclo                       WHERE programacion.estado = 1                      ORDER BY programacion.cod_programacion DESC";      $consulta = mysql_query ($instruccion, $conexion);      $row = mysql_fetch_array ($consulta);                $valdesc = "";      $descp = "--";          print("<option value=".$valdesc.">".$descp."</option>");          do{            print("<option value=".$row['cod_programacion'].">".$row['cod_programacion']." - [".$row['nombre']."]</option>");        }while ($row = mysql_fetch_array($consulta));         print("</SELECT></TD>");                ////BUSCAMOS LOS DEPARTAMENTOS      print ("<TD>Departamento ");      print ("<SELECT NAME='departamento'>");                      $instruccion = "SELECT cod_departamento, nombre FROM departamento ORDER BY cod_departamento";      $consulta = mysql_query ($instruccion, $conexion);      $row = mysql_fetch_array ($consulta);               $valdesc = "";      $descp = "--";          print("<option value=".$valdesc.">".$descp."</option>");          do{            print("<option value=".$row['cod_departamento'].">".$row['nombre']."</option>");        }while ($row = mysql_fetch_array($consulta));         print("</SELECT></TD>");                                            ////MOSTRAMOS LAS PAGINAS      if($num_paginas>0){        print ("<TD>Pagina ");        print ("<SELECT NAME='pagina'>");                 $cont_pag = 1;                 $valdesc_p = 0;        $descp_p = "--";            print("<option value=".$valdesc_p.">".$descp_p."</option>");            do{              print("<option value=".$cont_pag.">".$cont_pag."</option>");             $cont_pag++;          }while ($cont_pag<=$num_paginas);           print("</SELECT></TD></TR>");           }                      print ("<TD><INPUT TYPE='submit' NAME='consultar' VALUE='Consultar'></TD>");        print ("</FORM>");      print ("</TD></TR><tr><td>&nbsp;</td></tr></table>");           ////GENERAMOS LA CONDICION DE LA CONSULTA      $condicion = " WHERE ";            if($cod_programacion != '' && $cod_programacion2 != '' && $cod_programacion3 != '' && $cod_programacion4 != ''){         $condicion2 = $condicion2. "calculo_requerimientos.cod_ingrediente = 11 AND (calculo_requerimientos.cod_programacion = '$cod_programacion' OR  calculo_requerimientos.cod_programacion = '$cod_programacion2' OR  calculo_requerimientos.cod_programacion = '$cod_programacion3' OR  calculo_requerimientos.cod_programacion = '$cod_programacion4') AND ";         $condicion3 = $condicion3. "calculo_redondeado_escuela.cod_ingrediente = 11 AND (calculo_redondeado_escuela.cod_programacion = '$cod_programacion' OR  calculo_redondeado_escuela.cod_programacion = '$cod_programacion2' OR  calculo_redondeado_escuela.cod_programacion = '$cod_programacion3' OR  calculo_redondeado_escuela.cod_programacion = '$cod_programacion4') AND ";                }       if($cod_departamento!= ''){         $condicion2 = $condicion2. "calculo_requerimientos.cod_departamento = '$cod_departamento' AND ";         $condicion3 = $condicion3. "calculo_redondeado_escuela.cod_departamento = '$cod_departamento' AND ";         }                                         $condicion2 = substr($condicion2, 0, -4);                 $condicion_final = $condicion.$condicion2;                  $condicion3 = substr($condicion3, 0, -4);                 $condicion_final3 = $condicion.$condicion3;                           if($condicion_final == " WHERE "){           $condicion_final = " WHERE calculo_requerimientos.cod_programacion = 0";           $limit = "LIMIT ".$pagina.",".$num_reg_pag;           }else{            $limit = "";            }                  ////EJECUTAMOS LA CONSULTA      $instruccion2 ="SELECT DISTINCT calculo_requerimientos.cod_municipio AS cod_municipio, municipio.nombre AS nom_municipio,                                       calculo_requerimientos.cod_tipo_minuta AS cod_tipo_minuta, tipo_minuta.nombre AS nom_tipo_minuta                      FROM calculo_requerimientos                       INNER JOIN municipio ON municipio.cod_municipio = calculo_requerimientos.cod_municipio                      INNER JOIN tipo_minuta ON tipo_minuta.cod_tipo_minuta = calculo_requerimientos.cod_tipo_minuta                        $condicion_final                        ORDER BY calculo_requerimientos.cod_tipo_minuta, municipio.nombre                                          ";           $consulta2 = mysql_query($instruccion2);      error_consulta($consulta2,$instruccion2);           ////MOSTRAMOS LOS RESULTADOS DE LA CONSULTA      $nfilas = mysql_num_rows ($consulta2);       if ($nfilas > 0){       if($cod_programacion != '' && $cod_programacion2 != '' && $cod_programacion3 != '' && $cod_programacion4 != ''){              ////ENCABEZADO DE LA TABLA DE RESULTADOS        $hojaExcel="<TABLE width='50%'>";        $hojaExcel.="<TR><TH colspan='3'><center>INFORME DE BIENESTARINA -- [Programación: $cod_programacion Y $cod_programacion2 Y $cod_programacion3 Y $cod_programacion4] </center></TH></TR>";               $hojaExcel.="<TH><center>Municipio</center></TH>";        $hojaExcel.="<TH><center>Cupos</center></TH>";        $hojaExcel.="<TH><center>Cantidad [Unidades X 900 grs] </center></TH>";        $hojaExcel.="</TR>";              $color = '';         for ($i=0; $i<$nfilas; $i++){                     $conta = $conta + 1;                        ////DEFINIMOS EL COLOR DE LA FILA            $resto = $i%2;                        if($resto==0){               $color = '#D8D8D8';              }            if($resto!=0){               $color = '#848484';              }                          ////ESCRIBIMOS LOS RESULTADOS            $row2 = mysql_fetch_array($consulta2);            $cantidad_tipo_minuta = '';                        $cod_municipio = $row2['cod_municipio'];            $nom_municipio = $row2['nom_municipio'];            $cod_tipo_minuta = $row2['cod_tipo_minuta'];            $nom_tipo_minuta = $row2['nom_tipo_minuta'];                        ////BUSCAMOS LA CANTIDAD DE VECES QUE ESTA EL TIPO DE MINUTA            $instruccion_ctm ="SELECT DISTINCT calculo_requerimientos.cod_municipio AS cod_municipio, municipio.nombre AS nom_municipio,                                 calculo_requerimientos.cod_tipo_minuta AS cod_tipo_minuta, tipo_minuta.nombre AS nom_tipo_minuta                               FROM calculo_requerimientos                                INNER JOIN municipio ON municipio.cod_municipio = calculo_requerimientos.cod_municipio                               INNER JOIN tipo_minuta ON tipo_minuta.cod_tipo_minuta = calculo_requerimientos.cod_tipo_minuta                                 $condicion_final AND calculo_requerimientos.cod_tipo_minuta = $cod_tipo_minuta                               ";            $consulta_ctm  = mysql_query($instruccion_ctm);            error_consulta($consulta_ctm,$instruccion_ctm);                        ////MOSTRAMOS LOS RESULTADOS DE LA CONSULTA            $cantidad_tipo_minuta = mysql_num_rows ($consulta_ctm);                                                ////BUSCAMOS LA CANTIDAD POR MUNICIPIO PARA SER REDONDEADA            $instruccion ="SELECT SUM(calculo_redondeado_escuela.cantidad_redondeada) AS cantidad                            FROM calculo_redondeado_escuela                            $condicion_final3  AND calculo_redondeado_escuela.cod_municipio = $cod_municipio                            AND calculo_redondeado_escuela.cod_tipo_minuta = $cod_tipo_minuta                           ";                 $consulta = mysql_query($instruccion);            error_consulta($consulta,$instruccion);            $row = mysql_fetch_array($consulta);                      $cantidad = $row['cantidad'];                        $cantidad_total = $cantidad_total + $cantidad;                         $cantidad_subtotal = $cantidad_subtotal + $cantidad;                               ////BUSCAMOS LAS ESCUELAS Y LOS DIFERENTES RANGOS DE EDAD DEL MUNICIPIO  Y CUPOS            $instruccion_c ="SELECT DISTINCT calculo_requerimientos.cod_escuela AS cod_escuela, calculo_requerimientos.cod_rango_edad AS cod_rango_edad,                                             calculo_requerimientos.cupos AS cupos                             FROM calculo_requerimientos                              $condicion_final  AND calculo_requerimientos.cod_municipio = $cod_municipio                             AND calculo_requerimientos.cod_tipo_minuta = $cod_tipo_minuta                                                               ";                 $consulta_c = mysql_query($instruccion_c);            error_consulta($consulta_c,$instruccion_c);                        $nfilas_c = mysql_num_rows ($consulta_c);                         $cupos = 0;                          for ($c=0; $c<$nfilas_c; $c++){             $row_c = mysql_fetch_array($consulta_c);                          $cod_escuela = $row_c['cod_escuela'];             $cod_rango_edad = $row_c['cod_rango_edad'];             $cupos_sub = $row_c['cupos'];                           $cupos = $cupos + $cupos_sub;                                                     }                                         $cupos_total = $cupos_total + $cupos;                           $cupos_subtotal = $cupos_subtotal + $cupos;                                      if($cod_tipo_minuta != $cod_tipo_minuta_ant){               $hojaExcel.="<TR>";               $hojaExcel.="<TH colspan='3'><center>" . $row2[nom_tipo_minuta] ."</center></TH>";                $hojaExcel.="</TR>";                              $conta = '';             }                          $cod_tipo_minuta_ant = $cod_tipo_minuta;                          $hojaExcel.="<TR>";            $hojaExcel.="<TD style=background:$color>" . $row2['nom_municipio'] ."</TD>";             $hojaExcel.="<TD style=background:$color align='center'>" . $cupos . "</TD>";             $hojaExcel.="<TD style=background:$color align='center'>" . $cantidad . "</TD>";            $hojaExcel.="</TR>";            if($conta == ($cantidad_tipo_minuta-1)){                $hojaExcel.="<TR>";                $hojaExcel.="<TD style=background:$color><strong>SUBTOTAL</strong></TD>";                 $hojaExcel.="<TD style=background:$color align='center'><strong>" . $cupos_subtotal . "</strong></TD>";                 $hojaExcel.="<TD style=background:$color align='center'><strong>" . $cantidad_subtotal . "</strong></TD>";                $hojaExcel.="</TR>";                               $cupos_subtotal = 0;               $cantidad_subtotal = 0;              }           }                    $hojaExcel.="<TR>";          $hojaExcel.="<TD colspan='3'> &nbsp; </TD>";          $hojaExcel.="</TR>";          $hojaExcel.="<TR>";          $hojaExcel.="<TD style=background:$color><strong>TOTAL</strong></TD>";           $hojaExcel.="<TD style=background:$color align='center'><strong>" . $cupos_total . "</strong></TD>";           $hojaExcel.="<TD style=background:$color align='center'><strong>" . $cantidad_total . "</strong></TD>";          $hojaExcel.="</TR>";                    $hojaExcel.="</TABLE>";             echo $hojaExcel;                    $login=trim($_SESSION['login']);          $fecha = date("Ymd_His");          $sfile="../excel/InformeBienestarina"._."$login"._."$fecha.xls"; //ruta del archivo a generar           $fp=fopen($sfile,"w");           fwrite($fp,$hojaExcel);           fclose($fp);          echo "<br><a href='../excel/".$sfile."'><img src='../imagenes/excel.png' width='36' height='36' alt='Exportar a Microsoft Excel'></a>";           }else{            print ("<center><span class='Estilo1'>Debe seleccionar las Programaciones para generar el Informe</span></center>");            }       }else         print ("<center><span class='Estilo1'>No hay informacion disponible</span></center>");////Cerrar conexiónmysql_close ($conexion);?></div></body></html>